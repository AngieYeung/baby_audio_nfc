<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NFC Audio Player</title>
    <link rel="stylesheet" href="style.css">
    <meta name="description" content="NFC音频播放器 - 扫描标签播放专属音频">
</head>
<body>
    <div class="player-container">
        <h1 id="audio-title">等待NFC音频...</h1>
        
        <div class="controls">
            <button id="playBtn" class="control-btn">▶ 播放</button>
            <button id="pauseBtn" class="control-btn">⏸ 停止</button>
        </div>
        
        <div class="volume-control">
            <label for="volume">音量:</label>
            <input type="range" id="volume" min="0" max="1" step="0.1" value="0.7">
        </div>
        
        <div class="progress-container" id="progressContainer">
            <div class="progress-bar" id="progressBar"></div>
        </div>
        
        <div class="audio-info">
            <span id="currentTime">0:00</span> / <span id="duration">0:00</span>
        </div>
        
        <div class="status" id="status">请扫描NFC标签</div>
        
        <div class="url-display" id="urlDisplay">
            <span>当前音频URL:</span>
            <input type="text" id="currentUrl" readonly>
            <button id="copyUrlBtn" class="control-btn">复制</button>
        </div>
    </div>

    <audio id="audioPlayer" muted></audio>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // DOM元素获取
            const audioPlayer = document.getElementById('audioPlayer');
            const playBtn = document.getElementById('playBtn');
            const pauseBtn = document.getElementById('pauseBtn');
            const statusText = document.getElementById('status');
            const volumeControl = document.getElementById('volume');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const currentTimeEl = document.getElementById('currentTime');
            const durationEl = document.getElementById('duration');
            const audioTitle = document.getElementById('audio-title');
            const currentUrlInput = document.getElementById('currentUrl');
            const copyUrlBtn = document.getElementById('copyUrlBtn');

            // 从URL获取音频参数
            const urlParams = new URLSearchParams(window.location.search);
            const audioFile = urlParams.get('audio');
            const autoPlay = urlParams.get('autoplay') === 'true';
            
            // 验证音频参数
            if (!audioFile) {
                statusText.textContent = "错误: URL中必须包含audio参数(如?audio=文件名.mp3)";
                disableControls();
                return;
            }
            
            // 初始化播放器
            initPlayer(audioFile);
            
            // 复制URL功能
            copyUrlBtn.addEventListener('click', function() {
                currentUrlInput.select();
                navigator.clipboard.writeText(currentUrlInput.value)
                    .then(() => {
                        statusText.textContent = "URL已复制到剪贴板";
                        setTimeout(updateStatus, 2000);
                    })
                    .catch(err => {
                        currentUrlInput.select();
                        document.execCommand('copy');
                        statusText.textContent = "URL已复制";
                        setTimeout(updateStatus, 2000);
                    });
            });
            
            // 初始化播放器函数
            function initPlayer(file) {
                // 设置音频源 - Netlify部署使用相对路径
                audioPlayer.src = `audio/${encodeURIComponent(file)}`;
                audioPlayer.crossOrigin = "anonymous";
                
                currentUrlInput.value = window.location.href;
                
                // 设置显示名称
                const displayName = getDisplayName(file);
                document.title = `${displayName} - NFC音频`;
                audioTitle.textContent = displayName;
                
                // 音量控制
                audioPlayer.volume = volumeControl.value;
                volumeControl.addEventListener('input', function() {
                    audioPlayer.volume = this.value;
                });
                
                // 播放控制
                playBtn.addEventListener('click', function() {
                    audioPlayer.muted = false;
                    audioPlayer.play().catch(e => {
                        statusText.textContent = "播放失败: " + e.message;
                    });
                });
                
                pauseBtn.addEventListener('click', function() {
                    audioPlayer.pause();
                    updateStatus();
                });
                
                // 音频事件监听
                setupAudioEventListeners();
                
                // 自动播放逻辑
                if (autoPlay) {
                    statusText.textContent = "准备自动播放...";
                    
                    // 等待音频加载完成
                    const tryAutoPlay = () => {
                        if (audioPlayer.readyState >= 3) {
                            attemptAutoPlay();
                        } else {
                            audioPlayer.addEventListener('canplay', attemptAutoPlay, { once: true });
                            // 设置超时，防止音频永远加载不完
                            setTimeout(attemptAutoPlay, 3000);
                        }
                    };
                    
                    const attemptAutoPlay = () => {
                        audioPlayer.play()
                            .then(() => {
                                statusText.textContent = "正在播放...";
                                // 成功播放后取消静音
                                setTimeout(() => {
                                    audioPlayer.muted = false;
                                }, 100);
                            })
                            .catch(error => {
                                console.log('自动播放被阻止:', error);
                                statusText.textContent = "点击页面任意处开始播放";
                                
                                const playOnClick = () => {
                                    audioPlayer.muted = false;
                                    audioPlayer.play()
                                        .then(() => {
                                            statusText.textContent = "正在播放...";
                                        })
                                        .catch(e => {
                                            statusText.textContent = "播放失败: " + e.message;
                                        });
                                    document.removeEventListener('click', playOnClick);
                                };
                                document.addEventListener('click', playOnClick);
                            });
                    };
                    
                    // 给音频一些时间加载
                    setTimeout(tryAutoPlay, 1000);
                }
            }
            
            // 获取显示名称
            function getDisplayName(filename) {
                return filename
                    .replace(/\.[^/.]+$/, "")
                    .replace(/[_-]/g, ' ')
                    .replace(/\b\w/g, l => l.toUpperCase());
            }
            
            // 设置音频事件监听器
            function setupAudioEventListeners() {
                audioPlayer.addEventListener('play', updateStatus);
                audioPlayer.addEventListener('pause', updateStatus);
                audioPlayer.addEventListener('timeupdate', updateProgress);
                audioPlayer.addEventListener('loadedmetadata', function() {
                    durationEl.textContent = formatTime(audioPlayer.duration);
                    updateStatus();
                });
                audioPlayer.addEventListener('ended', function() {
                    statusText.textContent = "播放结束";
                    progressBar.style.width = '0%';
                });
                audioPlayer.addEventListener('error', function() {
                    handleAudioError();
                });
                audioPlayer.addEventListener('loadstart', function() {
                    statusText.textContent = "开始加载音频...";
                });
                audioPlayer.addEventListener('canplay', function() {
                    statusText.textContent = "音频加载完成，准备播放";
                });
            }
            
            // 处理音频加载错误
            function handleAudioError() {
                const errorCode = audioPlayer.error ? audioPlayer.error.code : '未知错误';
                const errorMessages = {
                    1: "音频加载被中止",
                    2: "网络错误，请检查连接",
                    3: "音频解码错误",
                    4: "音频格式不支持"
                };
                
                statusText.textContent = `加载失败: ${errorMessages[errorCode] || '未知错误'}`;
                console.error('音频错误详情:', audioPlayer.error);
                disableControls();
            }
            
            // 更新进度条
            function updateProgress() {
                if (audioPlayer.duration) {
                    const progressPercent = (audioPlayer.currentTime / audioPlayer.duration) * 100;
                    progressBar.style.width = `${progressPercent}%`;
                    currentTimeEl.textContent = formatTime(audioPlayer.currentTime);
                }
            }
            
            // 点击进度条跳转
            progressContainer.addEventListener('click', function(e) {
                if (!audioPlayer.duration) return;
                const width = this.clientWidth;
                const clickX = e.offsetX;
                audioPlayer.currentTime = (clickX / width) * audioPlayer.duration;
            });
            
            // 更新状态文本
            function updateStatus() {
                if (audioPlayer.error) {
                    statusText.textContent = "播放错误";
                } else if (audioPlayer.readyState < 3) {
                    statusText.textContent = "加载中...";
                } else {
                    statusText.textContent = audioPlayer.paused ? 
                        (audioPlayer.currentTime > 0 ? "已暂停" : "准备就绪") : 
                        "播放中...";
                }
            }
            
            // 禁用控制元素
            function disableControls() {
                playBtn.disabled = true;
                pauseBtn.disabled = true;
                volumeControl.disabled = true;
                progressContainer.style.opacity = "0.5";
            }
            
            // 格式化时间显示
            function formatTime(seconds) {
                if (isNaN(seconds)) return "0:00";
                const mins = Math.floor(seconds / 60);
                const secs = Math.floor(seconds % 60);
                return `${mins}:${secs < 10 ? '0' : ''}${secs}`;
            }
        });
    </script>
</body>
</html>